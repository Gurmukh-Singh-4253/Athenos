<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Course</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='bootstrap.min.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <nav class="navbar navbar-expand-lg bg-body-tertiary fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="{{ url_for('dashboard') }}">Athenos</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('dashboard') }}">Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" aria-current="page" href="{{ url_for('create_course') }}">Create Course</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">Manage Courses</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('logout') }}">Logout</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-5">
        <h1>Create New Course</h1>
        <form method="POST">
            <div class="mb-3">
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="subject_option" id="existingSubject" value="existing">
                    <label class="form-check-label" for="existingSubject">
                        Add to Existing Subject
                    </label>
                    <select class="form-select mt-2" name="subject_option" aria-label="Select existing subject">
                        <option value="">Select an existing subject</option>
                        {% for subject in subjects %}
                            <option value="{{ subject.subject_id }}">{{ subject.subject_name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="subject_option" id="newSubject" value="new" checked>
                    <label class="form-check-label" for="newSubject">
                        Create New Subject
                    </label>
                    <input type="text" class="form-control mt-2" name="new_subject_name" placeholder="Enter new subject name" autofocus>
                </div>
            </div>

            <div id="chapters-container">
                </div>

            <button type="button" class="btn btn-info mb-3" onclick="addChapter()">Add Chapter</button>
            <button type="submit" class="btn btn-primary">Save Course Structure</button>
        </form>
    </div>

    <script>
        let chapterCount = 0;

        function addChapter() {
            chapterCount++;
            const chaptersContainer = document.getElementById('chapters-container');
            const chapterDiv = document.createElement('div');
            chapterDiv.classList.add('mb-3', 'border', 'p-2');
            chapterDiv.innerHTML = `
                <h4>Chapter ${chapterCount}</h4>
                <button type="button" class="btn btn-sm btn-danger float-end" onclick="removeChapter(this)">Remove Chapter</button>
                <div class="mb-2">
                    <label for="chapter_name_${chapterCount}" class="form-label">Chapter Name:</label>
                    <input type="text" class="form-control" id="chapter_name_${chapterCount}" name="chapter_name[]" required>
                </div>
                <div id="modules-container-${chapterCount}">
                    <h5>Modules</h5>
                    </div>
                <button type="button" class="btn btn-sm btn-outline-secondary mb-2" onclick="addModule(${chapterCount})">Add Module</button>
            `;
            chaptersContainer.appendChild(chapterDiv);
            addModule(chapterCount); // Add at least one module when a chapter is created
        }

        function removeChapter(button) {
            const chapterDiv = button.parentNode;
            chapterDiv.remove();
            // Re-index chapter headings if needed for display
            updateChapterHeadings();
        }

        function updateChapterHeadings() {
            const chapterHeadings = document.querySelectorAll('#chapters-container > div > h4');
            chapterHeadings.forEach((heading, index) => {
                heading.textContent = `Chapter ${index + 1}`;
            });
        }

        let moduleCounts = {};
        function addModule(chapterIndex) {
            if (!moduleCounts[chapterIndex]) {
                moduleCounts[chapterIndex] = 0;
            }
            moduleCounts[chapterIndex]++;
            const modulesContainer = document.getElementById(`modules-container-${chapterIndex}`);
            const moduleDiv = document.createElement('div');
            moduleDiv.classList.add('mb-2', 'border-bottom', 'pb-2', 'd-flex', 'justify-content-between', 'align-items-center');
            moduleDiv.innerHTML = `
                <div>
                    <div class="mb-1">
                        <label for="module_name_${chapterIndex}_${moduleCounts[chapterIndex]}" class="form-label">Module Name:</label>
                        <input type="text" class="form-control form-control-sm" id="module_name_${chapterIndex}_${moduleCounts[chapterIndex]}" name="module_name[${chapterIndex - 1}][]" required>
                    </div>
                    <div>
                        <label for="video_url_${chapterIndex}_${moduleCounts[chapterIndex]}" class="form-label">Video URL (Optional):</label>
                        <input type="url" class="form-control form-control-sm" id="video_url_${chapterIndex}_${moduleCounts[chapterIndex]}" name="video_url[${chapterIndex - 1}][]">
                    </div>
                </div>
                <button type="button" class="btn btn-sm btn-danger" onclick="removeModule(this)">Remove</button>
            `;
            modulesContainer.appendChild(moduleDiv);
        }

        function removeModule(button) {
            const moduleDiv = button.parentNode;
            moduleDiv.remove();
        }

        // Initialize with one chapter
        addChapter();

        // Initially hide the existing subject dropdown
        const existingSubjectSelect = document.querySelector('select[name="subject_option"]');
        if (existingSubjectSelect) {
            existingSubjectSelect.style.display = 'none';
        }

        // JavaScript to toggle visibility of the select based on the radio button
        document.addEventListener('change', function(event) {
            if (event.target.name === 'subject_option') {
                const newSubjectInput = document.querySelector('input[name="new_subject_name"]');
                const existingSubjectSelect = document.querySelector('select[name="subject_option"]');
                if (document.getElementById('newSubject').checked) {
                    newSubjectInput.style.display = 'block';
                    existingSubjectSelect.style.display = 'none';
                    newSubjectInput.focus(); // Set focus to the new subject input
                } else if (document.getElementById('existingSubject').checked) {
                    newSubjectInput.style.display = 'none';
                    existingSubjectSelect.style.display = 'block';
                    existingSubjectSelect.focus(); // Set focus to the existing subject select
                }
            }
        });
    </script>
</body>
</html>
